<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wy≈õlij wiadomo≈õƒá - AnonLink</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <meta property="og:title" content="Wy≈õlij anonimowƒÖ wiadomo≈õƒá na AnonLink">
    <meta property="og:description" content="Wy≈õlij szczerƒÖ, anonimowƒÖ wiadomo≈õƒá do swoich znajomych na AnonLink.">
    <meta property="og:image" content="https://i.postimg.cc/Bbg49svM/anonlink-logo.png">
    <meta property="og:url" content="https://anonlink.fun/send.html">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Wy≈õlij anonimowƒÖ wiadomo≈õƒá na AnonLink">
    <meta name="twitter:description" content="Wy≈õlij szczerƒÖ, anonimowƒÖ wiadomo≈õƒá do swoich znajomych na AnonLink.">
    <meta name="twitter:image" content="https://i.postimg.cc/Bbg49svM/anonlink-logo.png">
    <style>
        /* Custom styles for the body background gradient and font */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-5">
    <div class="container bg-white rounded-2xl p-10 shadow-xl max-w-2xl w-full">
        <div class="header text-center mb-8">
            <img src="https://i.postimg.cc/Bbg49svM/anonlink-logo.png" alt="AnonLink Logo" class="mx-auto mb-5 w-32 h-32 object-contain rounded-full">
            <div class="logo text-4xl font-bold text-indigo-600 mb-2">üìù AnonLink</div>
            <p class="text-gray-700 text-lg">Wy≈õlij anonimowƒÖ wiadomo≈õƒá</p>
        </div>
        
        <div class="recipient bg-gray-50 p-4 rounded-lg mb-6 text-center border-2 border-gray-200" id="recipientInfo">
            <div class="recipient-label text-gray-600 text-sm mb-1">Wysy≈Çasz do:</div>
            <div class="recipient-name text-xl font-bold text-gray-800" id="recipientName">≈Åadowanie...</div>
        </div>
        
        <div class="anonymous-note bg-blue-50 p-5 rounded-lg mb-6 border-l-4 border-blue-500">
            <h4 class="text-blue-800 font-semibold mb-2 text-lg">üï∂Ô∏è Ca≈Çkowicie anonimowo</h4>
            <p class="text-gray-700 leading-relaxed">Twoja wiadomo≈õƒá zostanie wys≈Çana ca≈Çkowicie anonimowo. Odbiorca nie bƒôdzie wiedzia≈Ç, kto jƒÖ wys≈Ça≈Ç. BƒÖd≈∫ szczery, ale te≈º uprzejmy!</p>
        </div>
        
        <div id="successMessage" class="success-message bg-green-100 text-green-800 p-5 rounded-lg mb-5 text-center hidden"></div>
        <div id="errorMessage" class="error-message bg-red-100 text-red-800 p-5 rounded-lg mb-5 text-center hidden"></div>
        
        <form id="messageForm">
            <div class="form-group mb-6">
                <label for="message" class="block mb-2 font-semibold text-gray-800 text-base">Twoja wiadomo≈õƒá:</label>
                <textarea 
                    id="message" 
                    name="message" 
                    placeholder="Napisz tutaj swojƒÖ szczerƒÖ, anonimowƒÖ wiadomo≈õƒá..."
                    maxlength="1000"
                    required
                    class="w-full min-h-[150px] p-4 border-2 border-gray-300 rounded-xl text-base font-sans resize-y focus:outline-none focus:border-indigo-500 transition-colors duration-300"
                ></textarea>
                <div class="char-counter text-right text-gray-600 text-sm mt-1">
                    <span id="charCount">0</span>/1000 znak√≥w
                </div>
            </div>
            
            <button type="submit" class="btn w-full py-4 px-8 bg-gradient-to-r from-indigo-500 to-purple-600 text-white text-lg font-semibold rounded-xl cursor-pointer hover:scale-105 transition-transform duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none" id="sendBtn">
                üì§ Wy≈õlij anonimowo
            </button>
        </form>
        
        <div class="back-link text-center mt-5">
            <a href="https://anonlink.fun" class="text-indigo-600 hover:underline font-medium">‚Üê Stw√≥rz w≈Çasny link</a>
        </div>
    </div>
    
    <script>
        let recipient = ''; // This will store the recipient username from URL
        let backendRecipientName = ''; // This will store the recipient name confirmed by backend
        const BACKEND_BASE_URL = 'https://tbh-fun.onrender.com'; // Your backend base URL

        // ZMIANA: Zmienna do ≈õledzenia ostatniego czasu wys≈Çania i cooldownu
        let lastSendTime = 0; // Czas w milisekundach od Epoki
        const COOLDOWN_SECONDS = 10; // Cooldown w sekundach

        // Pobierz odbiorcƒô z URL jako identyfikator
        const urlParams = new URLSearchParams(window.location.search);
        recipient = urlParams.get('to');

        // Funkcja do pobierania szczeg√≥≈Ç√≥w odbiorcy z backendu
        async function fetchRecipientDetails(username) {
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/get_user_details?username=${encodeURIComponent(username)}`);
                const data = await response.json();

                if (response.ok && data.exists && data.username) {
                    return data.username; // Zwr√≥ƒá potwierdzonƒÖ nazwƒô u≈ºytkownika z backendu
                } else {
                    console.error('Backend did not confirm recipient or user does not exist:', data.message || 'Unknown error');
                    return null;
                }
            } catch (error) {
                console.error('Error fetching recipient details from backend:', error);
                return null;
            }
        }

        // Inicjalizacja odbiorcy na stronie
        async function initializeRecipient() {
            if (!recipient) {
                showError('Nieprawid≈Çowy link. Brak identyfikatora odbiorcy w URL.');
                document.getElementById('recipientName').textContent = 'Brak odbiorcy';
                return;
            }

            document.getElementById('recipientName').textContent = 'Sprawdzanie odbiorcy...';
            backendRecipientName = await fetchRecipientDetails(recipient);

            if (backendRecipientName) {
                document.getElementById('recipientName').textContent = '@' + backendRecipientName;
            } else {
                showError('Nie mo≈ºna znale≈∫ƒá odbiorcy lub odbiorca nie istnieje.');
                document.getElementById('recipientName').textContent = 'Nieznany odbiorca';
            }
        }

        // Licznik znak√≥w
        const messageTextarea = document.getElementById('message');
        const charCountSpan = document.getElementById('charCount');
        const charCounter = document.querySelector('.char-counter');
        const sendBtn = document.getElementById('sendBtn'); // ZMIANA: Przeniesiono tutaj

        messageTextarea.addEventListener('input', function() {
            const length = this.value.length;
            charCountSpan.textContent = length;
            
            if (length > 900) {
                charCounter.classList.add('text-red-500'); // Tailwind class for warning
            } else {
                charCounter.classList.remove('text-red-500');
            }
        });
        
        // ZMIANA: Funkcja aktualizujƒÖca odliczanie na przycisku
        let cooldownInterval;
        function updateCooldownButton() {
            const now = Date.now();
            const timeElapsed = (now - lastSendTime) / 1000; // Czas w sekundach
            const timeLeft = COOLDOWN_SECONDS - timeElapsed;

            if (timeLeft > 0) {
                sendBtn.disabled = true;
                sendBtn.textContent = `üì§ Poczekaj ${Math.ceil(timeLeft)}s`;
                if (!cooldownInterval) {
                    cooldownInterval = setInterval(updateCooldownButton, 1000); // Aktualizuj co sekundƒô
                }
            } else {
                sendBtn.disabled = false;
                sendBtn.textContent = 'üì§ Wy≈õlij anonimowo';
                clearInterval(cooldownInterval);
                cooldownInterval = null;
            }
        }
        
        // Obs≈Çuga formularza
        document.getElementById('messageForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const message = messageTextarea.value.trim();
            
            if (!message) {
                showError('Wiadomo≈õƒá nie mo≈ºe byƒá pusta!');
                return;
            }
            
            // U≈ºyj nazwy odbiorcy potwierdzonej przez backend
            if (!backendRecipientName) {
                showError('B≈ÇƒÖd: Odbiorca nie zosta≈Ç poprawnie za≈Çadowany z backendu. Spr√≥buj od≈õwie≈ºyƒá stronƒô.');
                return;
            }

            // ZMIANA: Sprawd≈∫ cooldown przed wys≈Çaniem
            const now = Date.now();
            if (now - lastSendTime < COOLDOWN_SECONDS * 1000) {
                showError(`Mo≈ºesz wysy≈Çaƒá wiadomo≈õci tylko raz na ${COOLDOWN_SECONDS} sekund. Poczekaj jeszcze ${Math.ceil((COOLDOWN_SECONDS * 1000 - (now - lastSendTime)) / 1000)}s.`);
                return;
            }
            
            // Dezaktywuj przycisk podczas wysy≈Çania
            sendBtn.disabled = true;
            sendBtn.textContent = 'üì§ Wysy≈Çanie...';
            
            // Wy≈õlij wiadomo≈õƒá
            fetch(`${BACKEND_BASE_URL}/send_message`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to: backendRecipientName, // U≈ºyj nazwy z backendu
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showSuccess('‚úÖ Wiadomo≈õƒá zosta≈Ça wys≈Çana anonimowo!');
                    messageTextarea.value = '';
                    charCountSpan.textContent = '0';
                    charCounter.classList.remove('text-red-500'); // Remove warning class
                    
                    // ZMIANA: Zaktualizuj czas ostatniego wys≈Çania
                    lastSendTime = Date.now();
                    updateCooldownButton(); // Rozpocznij odliczanie

                    // Wy≈õlij log aktywno≈õci do backendu (zamiast bezpo≈õrednio na webhooka)
                    fetch(`${BACKEND_BASE_URL}/log_activity`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: "Message Sent",
                            description: `Recipient: ${backendRecipientName}\nMessage: ${message.substring(0, 200)}...`,
                            color: 5763719 // Zielony
                        })
                    }).catch(error => console.error('B≈ÇƒÖd logowania aktywno≈õci wiadomo≈õci:', error));

                } else {
                    showError(data.message || 'WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania.');
                }
            })
            .catch(error => {
                showError('WystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie.');
                console.error('Error:', error);
            })
            .finally(() => {
                // ZMIANA: Nie aktywuj od razu, tylko zaktualizuj stan cooldownu
                updateCooldownButton(); 
            });
        });
        
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const errorDiv = document.getElementById('errorMessage');
            
            errorDiv.classList.add('hidden'); // Use Tailwind hidden class
            successDiv.textContent = message;
            successDiv.classList.remove('hidden'); // Show success message
            
            // Scroll do g√≥ry aby zobaczyƒá wiadomo≈õƒá
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                successDiv.classList.add('hidden'); // Hide after 5 seconds
            }, 5000);
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            
            successDiv.classList.add('hidden'); // Use Tailwind hidden class
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden'); // Show error message
            
            // Scroll do g√≥ry aby zobaczyƒá b≈ÇƒÖd
            window.scrollTo(0, 0);
            
            setTimeout(() => {
                errorDiv.classList.add('hidden'); // Hide after 5 seconds
            }, 5000);
        }

        // Wywo≈Çaj logowanie wizyty do backendu (zamiast bezpo≈õrednio na webhooka)
        window.addEventListener('load', async function() {
            try {
                await fetch(`${BACKEND_BASE_URL}/log_visit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page: 'send' })
                });
            } catch (error) {
                console.error('B≈ÇƒÖd logowania wizyty:', error);
            }
            
            await initializeRecipient(); // Inicjalizuj odbiorcƒô po za≈Çadowaniu strony i wys≈Çaniu danych o odwiedzajƒÖcym
            // ZMIANA: Upewnij siƒô, ≈ºe przycisk jest poprawnie ustawiony po za≈Çadowaniu
            updateCooldownButton(); 
        });
    </script>
</body>
</html>
